<!DOCTYPE html>
<html>

<head>
     <!--reset css cdn -->
     <!-- <link rel="stylesheet" type="text/css" href="assets/css/reset.css"> -->
     <!-- bootstrap theme courtesy of bootswatch.com -->
     <link rel="stylesheet" type="text/css" href="bsTheme.css">
     <!-- external css stylesheet -->
     <!-- <link rel="stylesheet" type="text/css" href="assets/css/style.css"> -->
     <!--jquery cdn -->
     <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
     <!-- moment.js cdn -->
     <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>
     <!-- Firebase Reference -->
     <script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
     <title>The Chimerical Express</title>
</head>

<body>
     <!-- Employee Tracker -->
     <div class="container">
          <!-- Jumbotron -->
          <div class="jumbotron" style="background-color: navy; color: white">
               <h1 class="text-center">The Chimerical Express</h1>
               <h5 class="text-center text-muted">Where you can schedule, maintain, and keep a constant eye on the train of your dreams</h5>
          </div>
          <div class="row">
               <div class="col-lg-12">
                    <!-- Current Employees-->
                    <div class="panel panel-primary">
                         <div class="panel-heading">
                              <h3 class="panel-title"><strong>Current Fleet Schedule</strong></h3>
                         </div>
                         <div class="panel-body">
                              <table class="table table-hover" id='train-data-table'>
                                   <thead>
                                        <tr>
                                             <th id="column-header"><strong>Train Name</strong></th>
                                             <th id="column-header"><strong>Destination</strong></th>
                                             <th id="column-header"><strong>Frequency of Arrival (minutes)</strong></th>
                                             <th id="column-header"><strong>Next Arrival</strong></th>
                                             <th id="column-header"><strong>Minutes Until Arrival</strong></th>
                                        </tr>
                                   </thead>
                                   <tbody>
                                   </tbody>
                              </table>
                         </div>
                    </div>
                    <!-- Add a train  -->
                    <div class="panel panel-primary">
                         <div class="panel-heading">
                              <h3 class="panel-title"><strong>Add a Train</strong></h3>
                         </div>
                         <div class="panel-body">
                              <!-- form to submit data -->
                              <form>
                                   <div class="form-group">
                                        <label for="employee-name-input">Train Name</label>
                                        <input class="form-control" id="train-name-input" type="text">
                                   </div>
                                   <div class="form-group">
                                        <label for="role-input">Destination</label>
                                        <input class="form-control" id="destination-input" type="text">
                                   </div>
                                   <div class="form-group">
                                        <label for="start-input">First Arrival of the Day (HH:MM - ex: 21:20)</label>
                                        <input class="form-control" id="first-train-input" type="text">
                                   </div>
                                   <div class="form-group">
                                        <label for="rate-input">Frequency (minutes)</label>
                                        <input class="form-control" id="frequency-input" type="text">
                                   </div>
                                   <div class="col-md-6">
                                        <button class="btn btn-primary" id="add-train-btn" type="submit">Add Train</button>
                                   </div>
                                   <div class="col-md-6">
                                        <button class="btn btn-primary pull-right" id="update-data-show-panel-btn" type="submit">Edit Data</button>
                                   </div>
                              </form>
                         </div>
                    </div>
                    <!-- Edit train data  -->
                    <div class="panel panel-primary" id="edit-train-panel">
                         <div class="panel-heading">
                              <h3 class="panel-title"><strong>Edit Train Data</strong></h3>
                              <h6>Click on the data entry you wish to edit from the panel above</h6>
                         </div>
                         <div class="panel-body">
                              <!-- form to submit updated data -->
                              <form>
                                   <div class="form-group">
                                        <label for="train-name-input">Train Name</label>
                                        <input class="form-control" id="train-name-input-edit" type="text">
                                   </div>
                                   <div class="form-group">
                                        <label for="destination-input">Destination</label>
                                        <input class="form-control" id="destination-input-edit" type="text">
                                   </div>
                                   <div class="form-group">
                                        <label for="start-input">First Arrival of the Day (HH:MM - ex: 21:20)</label>
                                        <input class="form-control" id="first-train-input-edit" type="text">
                                   </div>
                                   <div class="form-group">
                                        <label for="frequency-input">Frequency (minutes)</label>
                                        <input class="form-control" id="frequency-input-edit" type="text">
                                   </div>
                                   <button class="btn btn-primary" id="update-data-btn" type="submit">Update Data</button>
                              </form>
                         </div>
                    </div>
               </div>
          </div>
     </div>
     <!-- JavaScript -->
     <script>// Global Variables \\
var anotherTrain = 0;
var hoursWaiting;

$("#edit-train-panel, #update-data-show-panel-btn").hide();

// Initialize Firebase
var config = {
     apiKey: "AIzaSyCNYgtHwHFhn_OTGyIHRE5vtUbxY_f3JW4",
     authDomain: "chimericalxpresstrainscheduler.firebaseapp.com",
     databaseURL: "https://chimericalxpresstrainscheduler.firebaseio.com",
     projectId: "chimericalxpresstrainscheduler",
     storageBucket: "chimericalxpresstrainscheduler.appspot.com",
     messagingSenderId: "563861524983"
};
firebase.initializeApp(config);
// set local variable to firebase.database() \\
var database = firebase.database();


// when user clicks add train button \\
$("#add-train-btn").on("click", function() {
     anotherTrain++;
     // prevent page refresh \\ 
     event.preventDefault();

     // store user input to local variable \\
     var trainName = $("#train-name-input").val().trim();
     var trainDestination = $("#destination-input").val().trim();
     var trainFirstArrival = $("#first-train-input").val().trim();
     var trainFrequency = $("#frequency-input").val().trim();

     // store related variables in object \\
     var newTrain = {
          name: trainName,
          destination: trainDestination,
          firstArrival: trainFirstArrival,
          frequency: trainFrequency
     }

     database.ref().push(newTrain);

     // Alert
     alert("train added");
     // Clears all of the text-boxes
     $("#train-name-input").val("");
     $("#destination-input").val("");
     $("#first-train-input").val("");
     $("#frequency-input").val("");
});

// Upon new entry to databse, update html with new data \\
database.ref().on("child_added", function(childSnapshot, prevChildKey) {
     console.log(childSnapshot.val());
     // Store everything into a variable.
     var trainName = childSnapshot.val().name;
     var trainDestination = childSnapshot.val().destination;
     var trainFirstArrival = childSnapshot.val().firstArrival;
     var trainFrequency = childSnapshot.val().frequency;



     var trainFirstArrivalAdjusted = moment(trainFirstArrival, "HH:mm").subtract(1, "year");
     // storing the minute value of first arrival in local variable \\
     var minutesOfFirstArrival = moment(trainFirstArrival, "HH:mm").minute();
     // storing the hour value of first arrival in local variable \\
     var hourOfFirstArrival = moment(trainFirstArrival, "HH:mm").hour();

     // store curent time formated in military in variavle called now \\\
     var currentTime = moment();
     // store current minute of hour in variable now2 \\
     var currentMinute = moment().get('minute');

     var currentHour = moment(currentTime, "HH:mm").hour();
     


     var diffTime = moment().diff(moment(trainFirstArrivalAdjusted), "minutes");



     var timeDifference = diffTime % trainFrequency; // minutes from last arrival


     var minutesTillArrival = trainFrequency - timeDifference; // minutes from last arrival 


     // checking to see if minutes to next arrival is greater than 60 \\
     if (currentHour - hourOfFirstArrival < 0) {
          // for every additional hour over the first sixty minutes, 
          // store that value in variable a1 \\
          var a1 = hourOfFirstArrival - currentHour;
          // converting hours to minutes \\
          minutesTillArrival = minutesTillArrival + (a1 * 60);
          // add extra time (in minutes) to current time (moment.js) to obtain value of next arrival\
          var nextTrain = moment().add(minutesTillArrival, "minutes");
          // formatting time to 12 hour standard \\
          var arrivaltime = moment(nextTrain).format("hh:mm a");

     } else {

          var nextTrain = moment().add(minutesTillArrival, "minutes");
          var arrivaltime = moment(nextTrain).format("hh:mm a");
     }

     // displaying up-to-date (upon-click  or refresh) data to html, reflective of firebase.database \\
     $("#train-data-table > tbody").prepend("<tr class='data-well'><td id='name-well'>" + trainName + "</td><td id='destination-well'>" + trainDestination + "</td><td id='frequency-well'>" +
          trainFrequency + "</td><td id='arrival-well'>" + arrivaltime + "</td><td id='minutes-till-well'>" + minutesTillArrival + "</td></tr>");
}); // closing addTrain on-click function \\


// When edit data button is clicked \\
// $("#update-data-show-panel-btn").on("click", function(){
//   event.preventDefault();

//   // Display edit data panel \\
//   $("#edit-train-panel").slideDown("fast");

//   $(".data-well").on("click", function(){

// if(this.indexOf(innerText) == "  "){
//   var a = this.indexOf(innerText)
// }
//       console.log(this.innerText);

    // var arrivalEdit =children.innerText").text();
    // var destinationEdit = $("#destination-well").text();
    // var frequencyEdit = $("#frequency-well").text();
  
    // console.log("frequencyEdit:  " + frequencyEdit);
    // console.log("nameEdit   " + nameEdit);
    // console.log("destinationEdit   " + destinationEdit);
    // console.log("arrivalEdit   " + arrivalEdit); 

     
</script>
</body>

</html>
